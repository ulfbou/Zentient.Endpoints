name: .NET Build with Debug Logging

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Print working directory
      run: pwd

    - name: List all files and folders in workspace
      run: ls -Rlah

    - name: Print environment variables
      run: env

    - name: Print important GitHub Actions environment variables
      run: |
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
        echo "GITHUB_REF: $GITHUB_REF"
        echo "GITHUB_SHA: $GITHUB_SHA"
        echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"

    - name: Find all .csproj files
      run: find . -name "*.csproj"

    - name: Print contents of solution file
      run: |
        if [ -f Zentient.Endpoints/Zentient.Endpoints.sln ]; then
          cat Zentient.Endpoints/Zentient.Endpoints.sln
        elif [ -f Zentient.Endpoints.sln ]; then
          cat Zentient.Endpoints.sln
        else
          echo "No solution file found!"
        fi

    - name: Enable detailed dotnet CLI debug output
      run: |
        export DOTNET_CLI_TELEMETRY_OPTOUT=1
        export DOTNET_CLI_UI_LANGUAGE="en"
        export DOTNET_CLI_CONTEXT_VERBOSE=1
        export DOTNET_CLI_CONTEXT_DIAGNOSTIC=1
        export NUGET_XMLDOC_MODE=skip
        echo "DOTNET_CLI_CONTEXT_VERBOSE=1"
        echo "DOTNET_CLI_CONTEXT_DIAGNOSTIC=1"

    - name: Run dotnet --info
      run: dotnet --info

    - name: Restore dependencies
      run: dotnet restore Zentient.Endpoints/Zentient.Endpoints.sln --verbosity diagnostic

    - name: Build
      run: dotnet build Zentient.Endpoints/Zentient.Endpoints.sln --no-restore --verbosity diagnostic

    - name: Test
      run: dotnet test Zentient.Endpoints/Zentient.Endpoints.sln --no-build --verbosity normal